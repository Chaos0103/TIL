# JPA 기본 키 생성 전략

* JPA에서 Entity 객체의 Id를 정의할 때, **직접 할당**하는 방법과 **자동 생성**하는 방법이 있다.
* 직접 할당
  * `@Id` 애노테이션으로만 Id를 지정한다.
* 자동 생성
  * `@Id`와 `@GeneratedValue`를 함께 사용한다.
  * GenerationType 옵션으로 전략을 지정한다.

# @GeneratedValue

```java
package jakarta.persistence;

@Target({ElementType.METHOD, ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
public @interface GeneratedValue {
    GenerationType strategy() default GenerationType.AUTO;

    String generator() default "";
}
```

# GenerationType 종류

```java
package jakarta.persistence;

public enum GenerationType {
    TABLE,
    SEQUENCE,
    IDENTITY,
    UUID,
    AUTO;

    private GenerationType() {
    }
}
```

## TABLE

* 특정 데이터베이스에 의존적이지 않다.
* 시퀀스 테이블을 만들어서 데이터베이스 시퀀스를 흉내낼 Id를 할당한다.
* `@TableGenerator`과 함께 사용할 수 있다.
* JPA DDL AUTO 설정이 되어있다면 하이버네이트가 시퀀스 테이블을 생성한다.

### 생성된 DDL

```sql
create table hibernate_sequences
(
    next_val      bigint,
    sequence_name varchar(255) not null,
    primary key (sequence_name)
);
create table member
(
    age       integer not null,
    member_id bigint  not null,
    name      varchar(255),
    primary key (member_id)
);
```

### INSERT

1. hibernate_sequences 테이블에서 시퀀스 조회
2. member_id 할당 후 JPA 영속화
3. hibernate_sequences 시퀀스 업데이트
4. 자동 flush 상황이나 수동 flush가 발생하면 member 테이블에 insert

## SEQUENCE

* 특정 데이터베이스에 의존적이다.
  * 데이터베이스의 sequence 객체를 이용해 유일한 값을 순서대로 생성한다.
* 사용 가능한 데이터베이스 종류: Oracle, DB2, H2 등
* `@SequenceGenerator`과 함께 사용할 수 있다.
* sequence 객체를 사용하지 않는 데이터베이스를 사용할 경우 Sequence를 관리할 테이블을 생성한다.
  * JPA DDL AUTO 설정이 되어있어야 한다.

### 생성된 DDL

```sql
create sequence member_seq start with 1 increment by 50;
create table member
(
    age       integer not null,
    member_id bigint  not null,
    name      varchar(255),
    primary key (member_id)
)
```

### INSERT

1. 사용 가능한 sequence가 있는지 확인
2. 사용 가능한 sequence가 존재하면 사용, 존재하지 않으면 member_seq를 조회하여 50만큼 증가 후 사용
3. member_id 할당 후 JPA 영속화
4. 자동 flush 상황이나 수동 flush가 발생하면 member 테이블에 insert

## IDENTITY

* 특정 데이터베이스에 의존적이다.
* 기본키 생성을 데이터베이스에게 위임한다. (ex: MySQL은 AUTO_INCREMENT)

### 생성된 DDL

```sql
create table member
(
    age       integer not null,
    member_id bigint generated by default as identity,
    name      varchar(255),
    primary key (member_id)
)
```

### INSERT

1. member_id의 값을 얻기위해 member 테이블에 insert
2. member_id 할당 후 JPA 영속화

## AUTO

* 데이터베이스에 따라 자동으로 3가지 전략 중 하나를 선택한다.

## 정리

* JPA 영속성 컨텍스트에서 객체를 관리하기 위해서는 무조건 Id가 존재해야 한다.
* TABLE, SEQUENCE 전략은 insert를 하지 않아도 Id값을 할당할 수 있기 때문에 commit 전까지 insert를 하지 않는다.
* IDENTITY 전략은 insert를 하지 않으면 Id값을 할당할 수 없다. 따라서 insert문을 날려서 확인 후 할당한다. 